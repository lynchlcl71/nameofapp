!function(){var f,d,w,I,r,m,J,K,L,M,t,z,E,N,B,O,P,Q,R,S,y,C,T,U,V,W,p,F=[].slice,D={}.hasOwnProperty,q=function(c,a){function b(){this.constructor=c}for(var h in a)D.call(a,h)&&(c[h]=a[h]);b.prototype=a.prototype;c.prototype=new b;c.__super__=a.prototype;return c},g=function(c,a){return function(){return c.apply(a,arguments)}},x=[].indexOf||function(c){for(var a=0,b=this.length;a<b;a++)if(a in this&&this[a]===c)return a;return-1};P=function(c){return this.map(function(){var a,b,h;h="";for(a=this;(null!=
a?a.nodeType:void 0)===Node.ELEMENT_NODE&&a!==c;)b=a.tagName.replace(":","\\:"),b=f(a.parentNode).children(b).index(a)+1,b="["+b+"]",h="/"+a.tagName.toLowerCase()+b+h,a=a.parentNode;return h}).get()};Q=function(c){var a,b;a=function(b){var a;a=E(b);b=N(b);return""+a+"["+b+"]"};b=function(b){var e;for(e="";b!==c;){if(null==b)throw Error("Called getPathTo on a node which was not a descendant of @rootNode. "+c);e=a(b)+"/"+e;b=b.parentNode}return e=("/"+e).replace(/\/$/,"")};return this.map(function(){return b(this)}).get()};
M=function(c,a,b){var h,e,l,k,f;if(!c.hasChildNodes())throw Error("XPath error: node has no children!");h=c.childNodes;k=e=0;for(f=h.length;k<f;k++)if(c=h[k],l=E(c),l===a&&(e+=1,e===b))return c;throw Error("XPath error: wanted child not found.");};E=function(c){c=c.nodeName.toLowerCase();switch(c){case "#text":return"text()";case "#comment":return"comment()";case "#cdata-section":return"cdata-section()";default:return c}};N=function(c){var a,b;a=0;for(b=c;b;)b.nodeName===c.nodeName&&a++,b=b.previousSibling;
return a};B=null;"undefined"!==typeof Gettext&&null!==Gettext?(S=new Gettext({domain:"annotator"}),B=function(c){return S.gettext(c)}):B=function(c){return c};p=function(c){return B(c)};"undefined"!==typeof jQuery&&null!==jQuery&&null!=(t=jQuery.fn)&&t.jquery||console.error(p("Annotator requires jQuery: have you included lib/vendor/jquery.js?"));JSON&&JSON.parse&&JSON.stringify||console.error(p("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?"));f=jQuery;m={flatten:function(c){var a;
a=function(b){var h,e,l,c;e=[];l=0;for(c=b.length;l<c;l++)h=b[l],e=e.concat(h&&f.isArray(h)?a(h):h);return e};return a(c)},contains:function(c,a){var b;for(b=a;null!=b;){if(b===c)return!0;b=b.parentNode}return!1},getTextNodes:function(c){var a;a=function(b){var h;if(b&&b.nodeType!==Node.TEXT_NODE){h=[];if(b.nodeType!==Node.COMMENT_NODE)for(b=b.lastChild;b;)h.push(a(b)),b=b.previousSibling;return h.reverse()}return b};return c.map(function(){return m.flatten(a(this))})},getLastTextNodeUpTo:function(c){var a;
switch(c.nodeType){case Node.TEXT_NODE:return c;case Node.ELEMENT_NODE:if(null!=c.lastChild&&(a=m.getLastTextNodeUpTo(c.lastChild),null!=a))return a}c=c.previousSibling;return null!=c?m.getLastTextNodeUpTo(c):null},getFirstTextNodeNotBefore:function(c){var a;switch(c.nodeType){case Node.TEXT_NODE:return c;case Node.ELEMENT_NODE:if(null!=c.firstChild&&(a=m.getFirstTextNodeNotBefore(c.firstChild),null!=a))return a}c=c.nextSibling;return null!=c?m.getFirstTextNodeNotBefore(c):null},readRangeViaSelection:function(c){var a;
a=m.getGlobal().getSelection();a.removeAllRanges();a.addRange(c.toRange());return a.toString()},xpathFromNode:function(c,a){var b;try{b=P.call(c,a)}catch(h){console.log("jQuery-based XPath construction failed! Falling back to manual."),b=Q.call(c,a)}return b},nodeFromXPath:function(c,a){var b,h,e,l,k,f;l=c.substring(1).split("/");e=a;k=0;for(f=l.length;k<f;k++)h=l[k],b=h.split("["),h=b[0],b=b[1],b=null!=b?parseInt((null!=b?b.split("]"):void 0)[0]):1,e=M(e,h.toLowerCase(),b);return e},escape:function(c){return c.replace(/&(?!\w+;)/g,
"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/\n/g,"<br>")}};m.uuid=function(){var c;c=0;return function(){return c++}}();m.getGlobal=function(){return function(){return this}()};m.maxZIndex=function(c){var a,b,h,e;e=[];b=0;for(h=c.length;b<h;b++)a=c[b],"static"===f(a).css("position")?e.push(-1):e.push(parseFloat(f(a).css("z-index"))||-1);return Math.max.apply(Math,e)};m.mousePosition=function(c,a){var b;"absolute"!==(b=f(a).css("position"))&&"fixed"!==b&&"relative"!==
b&&(a=f(a).offsetParent()[0]);b=f(a).offset();return{top:c.pageY-b.top,left:c.pageX-b.left}};m.preventEventDefault=function(c){return null!=c?"function"===typeof c.preventDefault?c.preventDefault():void 0:void 0};z="log debug info warn exception assert dir dirxml trace group groupEnd groupCollapsed time timeEnd profile profileEnd count clear table error notifyFirebug firebug userObjects".split(" ");if("undefined"!==typeof console&&null!==console)for(null==console.group&&(console.group=function(c){return console.log("GROUP: ",
c)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),y=0,C=z.length;y<C;y++)t=z[y],null==console[t]&&(console[t]=function(){return console.log(p("Not implemented:")+(" console."+name))});else{this.console={};y=0;for(C=z.length;y<C;y++)t=z[y],this.console[t]=function(){};this.console.error=function(){var c;c=1<=arguments.length?F.call(arguments,0):[];return alert("ERROR: "+c.join(", "))};this.console.warn=function(){var c;c=1<=arguments.length?F.call(arguments,0):[];return alert("WARNING: "+
c.join(", "))}}w=function(){function c(a,b){this.options=f.extend(!0,{},this.options,b);this.element=f(a);this._closures={};this.on=this.subscribe;this.addEvents()}c.prototype.events={};c.prototype.options={};c.prototype.element=null;c.prototype.destroy=function(){return this.removeEvents()};c.prototype.addEvents=function(){var a,b,h,e,l;e=c._parseEvents(this.events);l=[];b=0;for(h=e.length;b<h;b++)a=e[b],l.push(this._addEvent(a.selector,a.event,a.functionName));return l};c.prototype.removeEvents=
function(){var a,b,h,e,l;e=c._parseEvents(this.events);l=[];b=0;for(h=e.length;b<h;b++)a=e[b],l.push(this._removeEvent(a.selector,a.event,a.functionName));return l};c.prototype._addEvent=function(a,b,h){var e,l=this;e=function(){return l[h].apply(l,arguments)};""===a&&c._isCustomEvent(b)?this.subscribe(b,e):this.element.delegate(a,b,e);this._closures[""+a+"/"+b+"/"+h]=e;return this};c.prototype._removeEvent=function(a,b,h){var e;e=this._closures[""+a+"/"+b+"/"+h];""===a&&c._isCustomEvent(b)?this.unsubscribe(b,
e):this.element.undelegate(a,b,e);delete this._closures[""+a+"/"+b+"/"+h];return this};c.prototype.publish=function(){this.element.triggerHandler.apply(this.element,arguments);return this};c.prototype.subscribe=function(a,b){var h;h=function(){return b.apply(this,[].slice.call(arguments,1))};h.guid=b.guid=f.guid+=1;this.element.bind(a,h);return this};c.prototype.unsubscribe=function(){this.element.unbind.apply(this.element,arguments);return this};return c}();w._parseEvents=function(c){var a,b,h,e,
l,k;b=[];for(e in c)h=c[e],a=e.split(" "),l=2<=a.length?F.call(a,0,k=a.length-1):(k=0,[]),a=a[k++],b.push({selector:l.join(" "),event:a,functionName:h});return b};w.natives=function(){var c,a,b;a=jQuery.event.special;b=[];for(c in a)D.call(a,c)&&b.push(c);return"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(b)}();w._isCustomEvent=
function(c){c=c.split(".")[0];return-1===f.inArray(c,w.natives)};r={sniff:function(c){if(null!=c.commonAncestorContainer)return new r.BrowserRange(c);if("string"===typeof c.start)return new r.SerializedRange(c);if(c.start&&"object"===typeof c.start)return new r.NormalizedRange(c);console.error(p("Could not sniff range type"));return!1},nodeFromXPath:function(c,a){var b,h,e,l;null==a&&(a=document);h=function(b,h){null==h&&(h=null);try{return document.evaluate("."+b,a,h,XPathResult.FIRST_ORDERED_NODE_TYPE,
null).singleNodeValue}catch(e){return console.log("XPath evaluation failed."),console.log("Trying fallback..."),m.nodeFromXPath(b,a)}};return f.isXMLDoc(document.documentElement)?(b=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),b=h(c,b),b||(c=function(){var b,a,h,e;h=c.split("/");e=[];b=0;for(a=h.length;b<a;b++)(l=h[b])&&-1===l.indexOf(":")?e.push(l.replace(/^([a-z]+)/,"xhtml:$1")):e.push(l);return e}().join("/"),e=document.lookupNamespaceURI(null),
b=function(b){return"xhtml"===b?e:document.documentElement.getAttribute("xmlns:"+b)},b=h(c,b)),b):h(c)}};r.RangeError=function(c){function a(b,h,e){this.type=b;this.message=h;this.parent=null!=e?e:null;a.__super__.constructor.call(this,this.message)}q(a,c);return a}(Error);r.BrowserRange=function(){function c(a){this.commonAncestorContainer=a.commonAncestorContainer;this.startContainer=a.startContainer;this.startOffset=a.startOffset;this.endContainer=a.endContainer;this.endOffset=a.endOffset}c.prototype.normalize=
function(a){var b,h,e,l;if(this.tainted)return console.error(p("You may only call normalize() once on a BrowserRange!")),!1;this.tainted=!0;e=h=void 0;this.startContainer.nodeType===Node.ELEMENT_NODE?(a=m.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),b=0):(a=this.startContainer,b=this.startOffset);if(this.endContainer.nodeType===Node.ELEMENT_NODE){l=this.endContainer.childNodes[this.endOffset];if(null!=l){for(;null!=l&&l.nodeType!==Node.TEXT_NODE;)l=l.firstChild;null!=
l&&(h=l,e=0)}null==h&&(l=this.endContainer.childNodes[this.endOffset-1],h=m.getLastTextNodeUpTo(l),e=h.nodeValue.length)}else h=this.endContainer,e=this.endOffset;l={};l.start=0<b?a.nodeValue.length>b?a.splitText(b):a.nextSibling:a;a===h?(l.start.nodeValue.length>e-b&&l.start.splitText(e-b),l.end=l.start):(h.nodeValue.length>e&&h.splitText(e),l.end=h);for(l.commonAncestor=this.commonAncestorContainer;l.commonAncestor.nodeType!==Node.ELEMENT_NODE;)l.commonAncestor=l.commonAncestor.parentNode;return new r.NormalizedRange(l)};
c.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)};return c}();r.NormalizedRange=function(){function c(a){this.commonAncestor=a.commonAncestor;this.start=a.start;this.end=a.end}c.prototype.normalize=function(a){return this};c.prototype.limit=function(a){var b,h,e,l,c;b=f.grep(this.textNodes(),function(b){return b.parentNode===a||f.contains(a,b.parentNode)});if(!b.length)return null;this.start=b[0];this.end=b[b.length-1];h=f(this.start).parents();c=f(this.end).parents();e=
0;for(l=c.length;e<l;e++)if(b=c[e],-1!==h.index(b)){this.commonAncestor=b;break}return this};c.prototype.serialize=function(a,b){var h,e;h=function(h,e){var c,d,g,n,u,A;c=b?f(h).parents(":not("+b+")").eq(0):f(h).parent();n=m.xpathFromNode(c,a)[0];c=m.getTextNodes(c);d=c.slice(0,c.index(h));u=g=0;for(A=d.length;u<A;u++)c=d[u],g+=c.nodeValue.length;return e?[n,g+h.nodeValue.length]:[n,g]};e=h(this.start);h=h(this.end,!0);return new r.SerializedRange({start:e[0],end:h[0],startOffset:e[1],endOffset:h[1]})};
c.prototype.text=function(){var a,b,h,e,c;e=this.textNodes();c=[];b=0;for(h=e.length;b<h;b++)a=e[b],c.push(a.nodeValue);return c.join("")};c.prototype.textNodes=function(){var a,b;a=m.getTextNodes(f(this.commonAncestor));b=[a.index(this.start),a.index(this.end)];return f.makeArray(a.slice(b[0],+b[1]+1||9E9))};c.prototype.toRange=function(){var a;a=document.createRange();a.setStartBefore(this.start);a.setEndAfter(this.end);return a};return c}();r.SerializedRange=function(){function c(a){this.start=
a.start;this.startOffset=a.startOffset;this.end=a.end;this.endOffset=a.endOffset}c.prototype.normalize=function(a){var b,h,e,c,k,d,v,g,n,u,A,p,q;k={};p=["start","end"];g=0;for(u=p.length;g<u;g++){c=p[g];try{e=r.nodeFromXPath(this[c],a)}catch(t){throw a=t,new r.RangeError(c,"Error while finding "+c+" node: "+this[c]+": "+a,a);}if(!e)throw new r.RangeError(c,"Couldn't find "+c+" node: "+this[c]);h=0;d=this[c+"Offset"];"end"===c&&d--;q=m.getTextNodes(f(e));n=0;for(A=q.length;n<A;n++)if(v=q[n],h+v.nodeValue.length>
d){k[c+"Container"]=v;k[c+"Offset"]=this[c+"Offset"]-h;break}else h+=v.nodeValue.length;if(null==k[c+"Offset"])throw new r.RangeError(""+c+"offset","Couldn't find offset "+this[c+"Offset"]+" in element "+this[c]);}b=null==document.compareDocumentPosition?function(b,a){return b.contains(a)}:function(b,a){return b.compareDocumentPosition(a)&16};f(k.startContainer).parents().each(function(){if(b(this,k.endContainer))return k.commonAncestorContainer=this,!1});return(new r.BrowserRange(k)).normalize(a)};
c.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)};c.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}};return c}();R=this.Annotator;d=function(c){function a(b,h){this.onDeleteAnnotation=g(this.onDeleteAnnotation,this);this.onEditAnnotation=g(this.onEditAnnotation,this);this.onAdderClick=g(this.onAdderClick,this);this.onAdderMousedown=g(this.onAdderMousedown,this);this.onHighlightMouseover=g(this.onHighlightMouseover,
this);this.checkForEndSelection=g(this.checkForEndSelection,this);this.checkForStartSelection=g(this.checkForStartSelection,this);this.clearViewerHideTimer=g(this.clearViewerHideTimer,this);this.startViewerHideTimer=g(this.startViewerHideTimer,this);this.showViewer=g(this.showViewer,this);this.onEditorSubmit=g(this.onEditorSubmit,this);this.onEditorHide=g(this.onEditorHide,this);this.showEditor=g(this.showEditor,this);a.__super__.constructor.apply(this,arguments);this.plugins={};if(!a.supported())return this;
this.options.readOnly||this._setupDocumentEvents();this._setupWrapper()._setupViewer()._setupEditor();this._setupDynamicStyle();this.adder=f(this.html.adder).appendTo(this.wrapper).hide();a._instances.push(this)}q(a,c);a.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"};a.prototype.html={adder:'<div class="annotator-adder"><button>'+
p("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'};a.prototype.options={readOnly:!1};a.prototype.plugins={};a.prototype.editor=null;a.prototype.viewer=null;a.prototype.selectedRanges=null;a.prototype.mouseIsDown=!1;a.prototype.ignoreMouseup=!1;a.prototype.viewerHideTimer=null;a.prototype._setupWrapper=function(){this.wrapper=f(this.html.wrapper);this.element.find("script").remove();this.element.wrapInner(this.wrapper);this.wrapper=this.element.find(".annotator-wrapper");
return this};a.prototype._setupViewer=function(){var b=this;this.viewer=new a.Viewer({readOnly:this.options.readOnly});this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(a,e){e.text?f(a).html(m.escape(e.text)):f(a).html("<i>"+p("No Comment")+"</i>");return b.publish("annotationViewerTextField",[a,e])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer});return this};a.prototype._setupEditor=
function(){this.editor=new a.Editor;this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:p("Take a note. Press Shift+Enter to make a new paragraph."),load:function(b,a){return f(b).find("textarea").val(a.text||"")},submit:function(b,a){return a.text=f(b).find("textarea").val()}});this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"checkbox",id:"private_note",label:"Don't share with my mentor",load:function(b,
a){return a["private"]?f(b).find("input").attr("checked","checked"):f(b).find("input").removeAttr("checked")},submit:function(b,a){return a["private"]=f("#private_note").is(":checked")}});this.editor.element.appendTo(this.wrapper);return this};a.prototype._setupDocumentEvents=function(){f(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});return this};a.prototype._setupDynamicStyle=function(){var b,a;a=f("#annotator-dynamic-style");a.length||(a=f('<style id="annotator-dynamic-style"></style>').appendTo(document.head));
var e,c,k,d;k=["adder","outer","notice","filter"];d=[];e=0;for(c=k.length;e<c;e++)b=k[e],d.push(":not(.annotator-"+b+")");b="*"+d.join("");b=m.maxZIndex(f(document.body).find(b));b=Math.max(b,1E3);a.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(b+20)+";","}\n.annotator-filter {","  z-index: "+(b+10)+";","}"].join("\n"));return this};a.prototype.destroy=function(){var b,h,e;a.__super__.destroy.apply(this,arguments);f(document).unbind({mouseup:this.checkForEndSelection,
mousedown:this.checkForStartSelection});f("#annotator-dynamic-style").remove();this.adder.remove();this.viewer.destroy();this.editor.destroy();this.wrapper.find(".annotator-hl").each(function(){f(this).contents().insertBefore(this);return f(this).remove()});this.wrapper.contents().insertBefore(this.wrapper);this.wrapper.remove();this.element.data("annotator",null);e=this.plugins;for(b in e)"function"===typeof(h=this.plugins[b]).destroy&&h.destroy();b=a._instances.indexOf(this);if(-1!==b)return a._instances.splice(b,
1)};a.prototype.getSelectedRanges=function(){var b,a,e,c,k,d,v,g,n;v=m.getGlobal().getSelection();k=[];d=[];v.isCollapsed||(k=function(){var k,f,g;g=[];a=k=0;for(f=v.rangeCount;0<=f?k<f:k>f;a=0<=f?++k:--k)c=v.getRangeAt(a),b=new r.BrowserRange(c),e=b.normalize().limit(this.wrapper[0]),null===e&&d.push(c),g.push(e);return g}.call(this),v.removeAllRanges());g=0;for(n=d.length;g<n;g++)c=d[g],v.addRange(c);return f.grep(k,function(b){b&&v.addRange(b.toRange());return b})};a.prototype.createAnnotation=
function(){var b;b={};this.publish("beforeAnnotationCreated",[b]);return b};a.prototype.setupAnnotation=function(b){var a,e,c,k,d,g,H;k=this.wrapper[0];b.ranges||(b.ranges=this.selectedRanges);e=[];H=b.ranges;d=0;for(g=H.length;d<g;d++){c=H[d];try{e.push(r.sniff(c).normalize(k)),this.publish("rangeNormalizeSuccess",[b,c])}catch(n){if(a=n,a instanceof r.RangeError)this.publish("rangeNormalizeFail",[b,c,a]);else throw a;}}b["private"];b.quote=[];b.ranges=[];b.highlights=[];c=0;for(k=e.length;c<k;c++)a=
e[c],b.quote.push(f.trim(a.text())),b.ranges.push(a.serialize(this.wrapper[0],".annotator-hl")),f.merge(b.highlights,this.highlightRange(a));b.quote=b.quote.join(" / ").replace(/"/g,'\\"');f(b.highlights).data("annotation",b);f(b.highlights).attr("data-annotation-id",b.id);return b};a.prototype.updateAnnotation=function(b){this.publish("beforeAnnotationUpdated",[b]);f(b.highlights).attr("data-annotation-id",b.id);this.publish("annotationUpdated",[b]);return b};a.prototype.deleteAnnotation=function(b){var a,
e,c,k;if(null!=b.highlights)for(k=b.highlights,e=0,c=k.length;e<c;e++)a=k[e],null!=a.parentNode&&f(a).replaceWith(a.childNodes);this.publish("annotationDeleted",[b]);return b};a.prototype.loadAnnotations=function(b){var a,e,c=this;null==b&&(b=[]);e=function(b){var f,d,g,n;null==b&&(b=[]);d=b.splice(0,10);g=0;for(n=d.length;g<n;g++)f=d[g],c.setupAnnotation(f);return 0<b.length?setTimeout(function(){return e(b)},10):c.publish("annotationsLoaded",[a])};a=b.slice();e(b);return this};a.prototype.dumpAnnotations=
function(){if(this.plugins.Store)return this.plugins.Store.dumpAnnotations();console.warn(p("Can't dump annotations without Store plugin."));return!1};a.prototype.highlightRange=function(b,a){var e,c,k,d,g,m,n;null==a&&(a="annotator-hl");k=/^\s*$/;e=f("<span class='"+a+"'></span>");m=b.textNodes();n=[];d=0;for(g=m.length;d<g;d++)c=m[d],k.test(c.nodeValue)||n.push(f(c).wrapAll(e).parent().show()[0]);this.publish("rangeHighlighted",[e]);return n};a.prototype.highlightRanges=function(b,a){var e,c,k,
d;null==a&&(a="annotator-hl");e=[];k=0;for(d=b.length;k<d;k++)c=b[k],f.merge(e,this.highlightRange(c,a));this.publish("rangesHighlighted",[e]);return e};a.prototype.addPlugin=function(b,h){var e,c;this.plugins[b]?console.error(p("You cannot have more than one instance of any plugin.")):(e=a.Plugin[b],"function"===typeof e?(this.plugins[b]=new e(this.element[0],h),this.plugins[b].annotator=this,"function"===typeof(c=this.plugins[b]).pluginInit&&c.pluginInit()):console.error(p("Could not load ")+b+
p(" plugin. Have you included the appropriate <script> tag?")));return this};a.prototype.showEditor=function(b,a){this.editor.element.css(a);this.editor.load(b);this.publish("annotationEditorShown",[this.editor,b]);return this};a.prototype.onEditorHide=function(){this.publish("annotationEditorHidden",[this.editor]);return this.ignoreMouseup=!1};a.prototype.onEditorSubmit=function(b){return this.publish("annotationEditorSubmit",[this.editor,b])};a.prototype.showViewer=function(b,a){this.viewer.element.css(a);
this.viewer.load(b);return this.publish("annotationViewerShown",[this.viewer,b])};a.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer)return this.viewerHideTimer=setTimeout(this.viewer.hide,600)};a.prototype.clearViewerHideTimer=function(){clearTimeout(this.viewerHideTimer);return this.viewerHideTimer=!1};a.prototype.checkForStartSelection=function(b){b&&this.isAnnotator(b.target)||this.startViewerHideTimer();return this.mouseIsDown=!0};a.prototype.checkForEndSelection=function(b){var a,
e,c,k;this.mouseIsDown=!1;if(!this.ignoreMouseup){k=this.selectedRanges=this.getSelectedRanges();e=0;for(c=k.length;e<c;e++)if(a=k[e],a=a.commonAncestor,this.isAnnotator(a))return;return b&&this.selectedRanges.length?this.adder.css(m.mousePosition(b,this.wrapper[0])).show():this.adder.hide()}};a.prototype.isAnnotator=function(b){return!!f(b).parents().addBack().filter("[class^=annotator-]").not("[class=annotator-hl]").not(this.wrapper).length};a.prototype.onHighlightMouseover=function(b){var a;this.clearViewerHideTimer();
if(this.mouseIsDown)return!1;this.viewer.isShown()&&this.viewer.hide();a=f(b.target).parents(".annotator-hl").addBack().map(function(){return f(this).data("annotation")}).toArray();return this.showViewer(a,m.mousePosition(b,this.wrapper[0]))};a.prototype.onAdderMousedown=function(b){null!=b&&b.preventDefault();return this.ignoreMouseup=!0};a.prototype.onAdderClick=function(b){var a,e,c,k,d=this;null!=b&&b.preventDefault();b=this.adder.position();this.adder.hide();a=this.setupAnnotation(this.createAnnotation());
f(a.highlights).addClass("annotator-hl-temporary");k=function(){c();f(a.highlights).removeClass("annotator-hl-temporary");return d.publish("annotationCreated",[a])};e=function(){c();return d.deleteAnnotation(a)};c=function(){d.unsubscribe("annotationEditorHidden",e);return d.unsubscribe("annotationEditorSubmit",k)};this.subscribe("annotationEditorHidden",e);this.subscribe("annotationEditorSubmit",k);return this.showEditor(a,b)};a.prototype.onEditAnnotation=function(b){var a,e,c,k=this;e=this.viewer.element.position();
c=function(){a();return k.updateAnnotation(b)};a=function(){k.unsubscribe("annotationEditorHidden",a);return k.unsubscribe("annotationEditorSubmit",c)};this.subscribe("annotationEditorHidden",a);this.subscribe("annotationEditorSubmit",c);this.viewer.hide();return this.showEditor(b,e)};a.prototype.onDeleteAnnotation=function(b){this.viewer.hide();return this.deleteAnnotation(b)};return a}(w);d.Plugin=function(c){function a(b,h){a.__super__.constructor.apply(this,arguments)}q(a,c);a.prototype.pluginInit=
function(){};return a}(w);t=m.getGlobal();null==(null!=(T=t.document)?T.evaluate:void 0)&&f.getScript("http://assets.annotateit.org/vendor/xpath.min.js");null==t.getSelection&&f.getScript("http://assets.annotateit.org/vendor/ierange.min.js");null==t.JSON&&f.getScript("http://assets.annotateit.org/vendor/json2.min.js");null==t.Node&&(t.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,
DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12});d.$=f;d.Delegator=w;d.Range=r;d.Util=m;d._instances=[];d._t=p;d.supported=function(){return function(){return!!this.getSelection}()};d.noConflict=function(){m.getGlobal().Annotator=R;return this};f.fn.annotator=function(c){var a;a=Array.prototype.slice.call(arguments,1);return this.each(function(){var b;b=f.data(this,"annotator");if("destroy"===c)return f.removeData(this,"annotator"),null!=b?b.destroy(a):void 0;if(b)return c&&b[c].apply(b,
a);b=new d(this,c);return f.data(this,"annotator",b)})};this.Annotator=d;d.Widget=function(c){function a(b,h){a.__super__.constructor.apply(this,arguments);this.classes=f.extend({},d.Widget.prototype.classes,this.classes)}q(a,c);a.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}};a.prototype.destroy=function(){this.removeEvents();return this.element.remove()};a.prototype.checkOrientation=function(){var b,a,e,c,k;this.resetOrientation();a=f(d.Util.getGlobal());
k=this.element.children(":first");c=k.offset();b=a.scrollTop();a=a.width()+a.scrollLeft();e=c.top;c=c.left+k.width();0>e-b&&this.invertY();0<c-a&&this.invertX();return this};a.prototype.resetOrientation=function(){this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y);return this};a.prototype.invertX=function(){this.element.addClass(this.classes.invert.x);return this};a.prototype.invertY=function(){this.element.addClass(this.classes.invert.y);return this};a.prototype.isInvertedY=
function(){return this.element.hasClass(this.classes.invert.y)};a.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)};return a}(w);d.Editor=function(c){function a(b){this.onCancelButtonMouseover=g(this.onCancelButtonMouseover,this);this.processKeypress=g(this.processKeypress,this);this.submit=g(this.submit,this);this.load=g(this.load,this);this.hide=g(this.hide,this);this.show=g(this.show,this);a.__super__.constructor.call(this,f(this.html)[0],b);this.fields=[];this.annotation=
{}}q(a,c);a.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"};a.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"};a.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+
p("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+p("Save")+"</a>\n   </div>\n  </form>\n</div>";a.prototype.options={};a.prototype.show=function(b){d.Util.preventEventDefault(b);this.element.removeClass(this.classes.hide);this.element.find(".annotator-save").addClass(this.classes.focus);this.checkOrientation();this.element.find(":input:first").focus();this.setupDraggables();return this.publish("show")};a.prototype.hide=function(b){d.Util.preventEventDefault(b);this.element.addClass(this.classes.hide);
return this.publish("hide")};a.prototype.load=function(b){var a,e,c;this.annotation=b;this.publish("load",[this.annotation]);c=this.fields;a=0;for(e=c.length;a<e;a++)b=c[a],b.load(b.element,this.annotation);return this.show()};a.prototype.submit=function(b){var a,e,c;d.Util.preventEventDefault(b);c=this.fields;a=0;for(e=c.length;a<e;a++)b=c[a],b.submit(b.element,this.annotation);this.publish("save",[this.annotation]);return this.hide()};a.prototype.addField=function(b){var a,e;a=f.extend({id:"annotator-field-"+
d.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},b);e=null;b=f('<li class="annotator-item" />');a.element=b[0];switch(a.type){case "textarea":e=f("<textarea />");break;case "input":case "checkbox":e=f("<input />");break;case "select":e=f("<select />")}b.append(e);e.attr({id:a.id,placeholder:a.label});"checkbox"===a.type&&(e[0].type="checkbox",b.addClass("annotator-checkbox"),b.append(f("<label />",{"for":a.id,html:a.label})));this.element.find("ul:first").append(b);this.fields.push(a);
return a.element};a.prototype.checkOrientation=function(){var b,c;a.__super__.checkOrientation.apply(this,arguments);c=this.element.find("ul");b=this.element.find(".annotator-controls");this.element.hasClass(this.classes.invert.y)?b.insertBefore(c):b.is(":first-child")&&b.insertAfter(c);return this};a.prototype.processKeypress=function(b){if(27===b.keyCode)return this.hide();if(13===b.keyCode&&!b.shiftKey)return this.submit()};a.prototype.onCancelButtonMouseover=function(){return this.element.find("."+
this.classes.focus).removeClass(this.classes.focus)};a.prototype.setupDraggables=function(){var b,a,c,l,k,d,g,m,n,u;this.element.find(".annotator-resize").remove();(c=this.element.hasClass(this.classes.invert.y)?this.element.find(".annotator-item:last"):this.element.find(".annotator-item:first"))&&f('<span class="annotator-resize"></span>').appendTo(c);k=null;b=this.classes;l=this.element;n=null;m=l.find(".annotator-resize");a=l.find(".annotator-controls");u=!1;c=function(b){if(b.target===this)return k=
{element:this,top:b.pageY,left:b.pageX},n=l.find("textarea:first"),f(window).bind({"mouseup.annotator-editor-resize":g,"mousemove.annotator-editor-resize":d}),b.preventDefault()};g=function(){k=null;return f(window).unbind(".annotator-editor-resize")};d=function(c){var e,f,d,g,G,v;if(k&&!1===u)return e=c.pageY-k.top,f=c.pageX-k.left,k.element===m[0]?(G=n.outerHeight(),v=n.outerWidth(),d=l.hasClass(b.invert.x)?-1:1,g=l.hasClass(b.invert.y)?1:-1,n.height(G+e*g),n.width(v+f*d),n.outerHeight()!==G&&(k.top=
c.pageY),n.outerWidth()!==v&&(k.left=c.pageX)):k.element===a[0]&&(l.css({top:parseInt(l.css("top"),10)+e,left:parseInt(l.css("left"),10)+f}),k.top=c.pageY,k.left=c.pageX),u=!0,setTimeout(function(){return u=!1},1E3/60)};m.bind("mousedown",c);return a.bind("mousedown",c)};return a}(d.Widget);d.Viewer=function(c){function a(b){this.onDeleteClick=g(this.onDeleteClick,this);this.onEditClick=g(this.onEditClick,this);this.load=g(this.load,this);this.hide=g(this.hide,this);this.show=g(this.show,this);a.__super__.constructor.call(this,
f(this.html.element)[0],b);this.item=f(this.html.item)[0];this.fields=[];this.annotations=[]}q(a,c);a.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"};a.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"};a.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'};
a.prototype.options={readOnly:!1};a.prototype.show=function(b){var a,c=this;d.Util.preventEventDefault(b);a=this.element.find(".annotator-controls").addClass(this.classes.showControls);setTimeout(function(){return a.removeClass(c.classes.showControls)},1E3);this.element.removeClass(this.classes.hide);return this.checkOrientation().publish("show")};a.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)};a.prototype.hide=function(b){d.Util.preventEventDefault(b);this.element.addClass(this.classes.hide);
return this.publish("hide")};a.prototype.load=function(b){var a,c,l,k,d,g,m,n,u,p,r,q,t;this.annotations=b||[];m=this.element.find("ul:first").empty();q=this.annotations;n=0;for(p=q.length;n<p;n++)for(b=q[n],g=f(this.item).clone().appendTo(m).data("annotation",b),c=g.find(".annotator-controls"),d=c.find(".annotator-link"),k=c.find(".annotator-edit"),l=c.find(".annotator-delete"),c=(new I(b.links||[])).get("alternate",{type:"text/html"}),0===c.length||null==c[0].href?d.remove():d.attr("href",c[0].href),
this.options.readOnly?(k.remove(),l.remove()):a={showEdit:function(){return k.removeAttr("disabled")},hideEdit:function(){return k.attr("disabled","disabled")},showDelete:function(){return l.removeAttr("disabled")},hideDelete:function(){return l.attr("disabled","disabled")}},t=this.fields,u=0,r=t.length;u<r;u++)c=t[u],d=f(c.element).clone().appendTo(g)[0],c.load(d,b,a);this.publish("load",[this.annotations]);return this.show()};a.prototype.addField=function(b){b=f.extend({load:function(){}},b);b.element=
f("<div />")[0];this.fields.push(b);b.element;return this};a.prototype.onEditClick=function(b){return this.onButtonClick(b,"edit")};a.prototype.onDeleteClick=function(b){return this.onButtonClick(b,"delete")};a.prototype.onButtonClick=function(b,a){var c;c=f(b.target).parents(".annotator-annotation");return this.publish(a,[c.data("annotation")])};return a}(d.Widget);I=function(){function c(a){this.data=a}c.prototype.get=function(a,b){var c,e,l,k,d,g,m,n;null==b&&(b={});b=f.extend({},b,{rel:a});l=
function(){var a;a=[];for(e in b)D.call(b,e)&&a.push(e);return a}();m=this.data;n=[];d=0;for(g=m.length;d<g;d++)c=m[d],(k=l.reduce(function(a,e){return a&&c[e]===b[e]},!0))&&n.push(c);return n};return c}();d=d||{};d.Notification=function(c){function a(b){this.hide=g(this.hide,this);this.show=g(this.show,this);a.__super__.constructor.call(this,f(this.options.html).appendTo(document.body)[0],b)}q(a,c);a.prototype.events={click:"hide"};a.prototype.options={html:"<div class='annotator-notice'></div>",
classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}};a.prototype.show=function(b,a){null==a&&(a=d.Notification.INFO);this.currentStatus=a;f(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(m.escape(b||""));setTimeout(this.hide,5E3);return this};a.prototype.hide=function(){null==this.currentStatus&&(this.currentStatus=d.Notification.INFO);f(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]);
return this};return a}(w);d.Notification.INFO="info";d.Notification.SUCCESS="success";d.Notification.ERROR="error";f(function(){var c;c=new d.Notification;d.showNotification=c.show;return d.hideNotification=c.hide});d.Plugin.Unsupported=function(c){function a(){return U=a.__super__.constructor.apply(this,arguments)}q(a,c);a.prototype.options={message:d._t("Sorry your current browser does not support the Annotator")};a.prototype.pluginInit=function(){var b=this;if(!d.supported())return f(function(){d.showNotification(b.options.message);
if(void 0===window.XMLHttpRequest&&void 0!==ActiveXObject)return f("html").addClass("ie6")})};return a}(d.Plugin);L=function(c){var a,b,h;c=c.match(/([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?/);b=0;a=new Date(c[1],0,1);c[3]&&a.setMonth(c[3]-1);c[5]&&a.setDate(c[5]);c[7]&&a.setHours(c[7]);c[8]&&a.setMinutes(c[8]);c[10]&&a.setSeconds(c[10]);c[12]&&a.setMilliseconds(1E3*Number("0."+c[12]));c[14]&&(b=60*Number(c[16])+Number(c[17]),
b*=null!=(h="-"===c[15])?h:NaN);b-=a.getTimezoneOffset();a.setTime(Number(Number(a)+6E4*b));return a};J=function(c){var a,b,h,e,l,d,f,g;if("undefined"!==typeof atob&&null!==atob)return atob(c);a=f=0;g=[];if(!c)return c;for(c+="";f<c.length;)h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(f++)),e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(f++)),l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(f++)),
d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(f++)),b=h<<18|e<<12|l<<6|d,h=b>>16&255,e=b>>8&255,b&=255,64===l?g[a++]=String.fromCharCode(h):64===d?g[a++]=String.fromCharCode(h,e):g[a++]=String.fromCharCode(h,e,b);return g.join("")};K=function(c){var a,b;a=c.length%4;if(0!==a)for(b=0,a=4-a;0<=a?b<a:b>a;0<=a?++b:--b)c+="=";c=c.replace(/-/g,"+");c=c.replace(/_/g,"/");return J(c)};O=function(c){c=c.split(".");return JSON.parse(K(c[1]))};d.Plugin.Auth=function(c){function a(b,
c){a.__super__.constructor.apply(this,arguments);this.waitingForToken=[];this.options.token?this.setToken(this.options.token):this.requestToken()}q(a,c);a.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0};a.prototype.requestToken=function(){var b=this;this.requestInProgress=!0;return f.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(a,c,l){return b.setToken(a)}).fail(function(b,a,c){a=d._t("Couldn't get auth token:");console.error(""+
a+" "+c,b);return d.showNotification(""+a+" "+b.responseText,d.Notification.ERROR)}).always(function(){return b.requestInProgress=!1})};a.prototype.setToken=function(b){var a=this;this.token=b;this._unsafeToken=O(b);if(this.haveValidToken()){this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(){return a.requestToken()},1E3*(this.timeToExpiry()-2)));this.updateHeaders();for(b=[];0<this.waitingForToken.length;)b.push(this.waitingForToken.pop()(this._unsafeToken));return b}console.warn(d._t("Didn't get a valid token."));
if(this.options.autoFetch)return console.warn(d._t("Getting a new token in 10s.")),setTimeout(function(){return a.requestToken()},1E4)};a.prototype.haveValidToken=function(){return this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey&&0<this.timeToExpiry()?!0:!1};a.prototype.timeToExpiry=function(){var b;b=(new Date).getTime()/1E3;b=L(this._unsafeToken.issuedAt).getTime()/1E3+this._unsafeToken.ttl-b;return 0<b?b:0};a.prototype.updateHeaders=function(){var b;
b=this.element.data("annotator:headers");return this.element.data("annotator:headers",f.extend(b,{"x-annotator-auth-token":this.token}))};a.prototype.withToken=function(b){if(null!=b){if(this.haveValidToken())return b(this._unsafeToken);this.waitingForToken.push(b);if(!this.requestInProgress)return this.requestToken()}};return a}(d.Plugin);d.Plugin.Store=function(c){function a(b,c){this._onError=g(this._onError,this);this._onLoadAnnotationsFromSearch=g(this._onLoadAnnotationsFromSearch,this);this._onLoadAnnotations=
g(this._onLoadAnnotations,this);this._getAnnotations=g(this._getAnnotations,this);a.__super__.constructor.apply(this,arguments);this.annotations=[]}q(a,c);a.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"};a.prototype.options={annotationData:{},emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}};
a.prototype.pluginInit=function(){if(d.supported())return this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations()};a.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations()};a.prototype.annotationCreated=function(b){var a=this;return 0>x.call(this.annotations,b)?(this.registerAnnotation(b),this._apiRequest("create",b,function(c){null==c.id&&console.warn(d._t("Warning: No ID returned from server for annotation "),
b);return a.updateAnnotation(b,c)})):this.updateAnnotation(b,{})};a.prototype.annotationUpdated=function(b){var a=this;if(0<=x.call(this.annotations,b))return this._apiRequest("update",b,function(c){return a.updateAnnotation(b,c)})};a.prototype.annotationDeleted=function(b){var a=this;if(0<=x.call(this.annotations,b))return this._apiRequest("destroy",b,function(){return a.unregisterAnnotation(b)})};a.prototype.registerAnnotation=function(b){return this.annotations.push(b)};a.prototype.unregisterAnnotation=
function(b){return this.annotations.splice(this.annotations.indexOf(b),1)};a.prototype.updateAnnotation=function(b,a){0>x.call(this.annotations,b)?console.error(d._t("Trying to update unregistered annotation!")):f.extend(b,a);return f(b.highlights).data("annotation",b)};a.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)};a.prototype._onLoadAnnotations=function(b){var a,c,l,f,d,g;null==b&&(b=[]);l={};d=this.annotations;c=0;for(f=d.length;c<f;c++)a=d[c],
l[a.id]=a;f=[];d=0;for(g=b.length;d<g;d++)a=b[d],l[a.id]?(c=l[a.id],this.updateAnnotation(c,a)):f.push(a);this.annotations=this.annotations.concat(f);return this.annotator.loadAnnotations(f.slice())};a.prototype.loadAnnotationsFromSearch=function(b){return this._apiRequest("search",b,this._onLoadAnnotationsFromSearch)};a.prototype._onLoadAnnotationsFromSearch=function(b){null==b&&(b={});return this._onLoadAnnotations(b.rows||[])};a.prototype.dumpAnnotations=function(){var b,a,c,d,f;d=this.annotations;
f=[];a=0;for(c=d.length;a<c;a++)b=d[a],f.push(JSON.parse(this._dataFor(b)));return f};a.prototype._apiRequest=function(b,a,c){var d,k;d=a&&a.id;k=this._urlFor(b,d);a=this._apiRequestOptions(b,a,c);k=f.ajax(k,a);k._id=d;k._action=b;return k};a.prototype._apiRequestOptions=function(b,a,c){var d;d=this._methodFor(b);c={type:d,headers:this.element.data("annotator:headers"),dataType:"json",success:c||function(){},error:this._onError};!this.options.emulateHTTP||"PUT"!==d&&"DELETE"!==d||(c.headers=f.extend(c.headers,
{"X-HTTP-Method-Override":d}),c.type="POST");if("search"===b)return c=f.extend(c,{data:a});b=a&&this._dataFor(a);return this.options.emulateJSON?(c.data={json:b},this.options.emulateHTTP&&(c.data._method=d),c):c=f.extend(c,{data:b,contentType:"application/json; charset=utf-8"})};a.prototype._urlFor=function(b,a){var c;c=null!=this.options.prefix?this.options.prefix:"";c+=this.options.urls[b];c=c.replace(/\/:id/,null!=a?"/"+a:"");return c=c.replace(/:id/,null!=a?a:"")};a.prototype._methodFor=function(b){return{create:"POST",
read:"GET",update:"PUT",destroy:"DELETE",search:"GET"}[b]};a.prototype._dataFor=function(b){var a,c;c=b.highlights;delete b.highlights;f.extend(b,this.options.annotationData);a=JSON.stringify(b);c&&(b.highlights=c);return a};a.prototype._onError=function(b){var a,c;a=b._action;c=d._t("Sorry, we could not ")+a+d._t(" this note.");"search"===b._action?c=d._t("Sorry, we could not search the server for notes."):"read"!==b._action||b._id||(c=d._t("Sorry, we were not able to load your notes."));switch(b.status){case 401:c=
d._t("Sorry, you are not allowed to ")+a+d._t(" this note.");break;case 404:c=d._t("Sorry, we could not connect to the notes server.");break;case 500:c=d._t("Sorry, something went wrong with the notes server.")}d.showNotification(c,d.Notification.ERROR);return console.error(d._t("API request failed:")+(" '"+b.status+"'"))};return a}(d.Plugin);d.Plugin.Permissions=function(c){function a(b,c){this._setAuthFromToken=g(this._setAuthFromToken,this);this.updateViewer=g(this.updateViewer,this);this.updateAnnotationPermissions=
g(this.updateAnnotationPermissions,this);this.updatePermissionsField=g(this.updatePermissionsField,this);this.addFieldsToAnnotation=g(this.addFieldsToAnnotation,this);a.__super__.constructor.apply(this,arguments);this.options.user&&(this.setUser(this.options.user),delete this.options.user)}q(a,c);a.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"};a.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(b){return b},userString:function(b){return b},
userAuthorize:function(b,a,c){var d,f;if(a.permissions){a=a.permissions[b]||[];if(0===a.length)return!0;d=0;for(f=a.length;d<f;d++)if(b=a[d],this.userId(c)===b)return!0;return!1}return a.user?c?this.userId(c)===this.userId(a.user):!1:!0},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}};a.prototype.pluginInit=function(){var b,a,c=this;if(d.supported()&&(a=this,b=function(b,c){return function(e,d){return a[b].call(a,c,e,d)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),
!0===this.options.showViewPermissionsCheckbox&&this.annotator.editor.addField({type:"checkbox",label:d._t("Allow anyone to <strong>view</strong> this annotation"),load:b("updatePermissionsField","read"),submit:b("updateAnnotationPermissions","read")}),!0===this.options.showEditPermissionsCheckbox&&this.annotator.editor.addField({type:"checkbox",label:d._t("Allow anyone to <strong>edit</strong> this annotation"),load:b("updatePermissionsField","update"),submit:b("updateAnnotationPermissions","update")}),
this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter))return this.annotator.plugins.Filter.addFilter({label:d._t("User"),property:"user",isFiltered:function(b,a){var h,d,f,g;a=c.options.userString(a);if(!b||!a)return!1;g=b.split(/\s*/);d=0;for(f=g.length;d<f;d++)if(h=g[d],-1===a.indexOf(h))return!1;return!0}})};a.prototype.setUser=function(b){return this.user=b};a.prototype.addFieldsToAnnotation=function(b){if(b&&(b.permissions=f.extend(!0,{},this.options.permissions),
this.user))return b.user=this.user};a.prototype.authorize=function(b,a,c){void 0===c&&(c=this.user);return this.options.userAuthorize?this.options.userAuthorize.call(this.options,b,a,c):!0};a.prototype.updatePermissionsField=function(b,a,c){var d;a=f(a).show();d=a.find("input").removeAttr("disabled");this.authorize("admin",c)||a.hide();return this.authorize(b,c||{},null)?d.attr("checked","checked"):d.removeAttr("checked")};a.prototype.updateAnnotationPermissions=function(b,a,c){c.permissions||(c.permissions=
f.extend(!0,{},this.options.permissions));return f(a).find("input").is(":checked")?c.permissions[b]=[]:c.permissions[b]=[this.options.userId(this.user)]};a.prototype.updateViewer=function(b,a,c){var l;b=f(b);l=this.options.userString(a.user);a.user&&l&&"string"===typeof l?(l=d.Util.escape(this.options.userString(a.user)),b.html(l).addClass("annotator-user")):b.remove();if(c&&(this.authorize("update",a)||c.hideEdit(),!this.authorize("delete",a)))return c.hideDelete()};a.prototype._setAuthFromToken=
function(b){return this.setUser(b.userId)};return a}(d.Plugin);d.Plugin.AnnotateItPermissions=function(c){function a(){this._setAuthFromToken=g(this._setAuthFromToken,this);this.updateAnnotationPermissions=g(this.updateAnnotationPermissions,this);this.updatePermissionsField=g(this.updatePermissionsField,this);this.addFieldsToAnnotation=g(this.addFieldsToAnnotation,this);return V=a.__super__.constructor.apply(this,arguments)}q(a,c);a.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,
groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(b){return b.userId},userString:function(b){return b.userId},userAuthorize:function(b,a,c){var d,f,g,m;b=(a.permissions||{})[b]||[];return(d=this.groups.world,0<=x.call(b,d))?!0:null!=c&&null!=c.userId&&null!=c.consumerKey?c.userId===a.user&&c.consumerKey===a.consumer?!0:(f=this.groups.authenticated,0<=x.call(b,f))?!0:c.consumerKey===a.consumer&&(g=this.groups.consumer,0<=x.call(b,
g))?!0:c.consumerKey===a.consumer&&(m=c.userId,0<=x.call(b,m))?!0:c.consumerKey===a.consumer&&c.admin?!0:!1:!1},permissions:{read:["group:__world__"],update:[],"delete":[],admin:[]}};a.prototype.addFieldsToAnnotation=function(b){if(b&&(b.permissions=this.options.permissions,this.user))return b.user=this.user.userId,b.consumer=this.user.consumerKey};a.prototype.updatePermissionsField=function(b,a,c){var d;a=f(a).show();d=a.find("input").removeAttr("disabled");this.authorize("admin",c)||a.hide();return this.user&&
this.authorize(b,c||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?d.attr("checked","checked"):d.removeAttr("checked")};a.prototype.updateAnnotationPermissions=function(b,a,c){c.permissions||(c.permissions=this.options.permissions);return f(a).find("input").is(":checked")?c.permissions[b]=["read"===b?this.options.groups.world:this.options.groups.consumer]:c.permissions[b]=[]};a.prototype._setAuthFromToken=function(b){return this.setUser(b)};return a}(d.Plugin.Permissions);d.Plugin.Filter=
function(c){function a(b,c){this._onPreviousClick=g(this._onPreviousClick,this);this._onNextClick=g(this._onNextClick,this);this._onFilterKeyup=g(this._onFilterKeyup,this);this._onFilterBlur=g(this._onFilterBlur,this);this._onFilterFocus=g(this._onFilterFocus,this);this.updateHighlights=g(this.updateHighlights,this);var e;b=f(this.html.element).appendTo((null!=c?c.appendTo:void 0)||this.options.appendTo);a.__super__.constructor.call(this,b,c);(e=this.options).filters||(e.filters=[]);this.filter=f(this.html.filter);
this.filters=[];this.current=0}q(a,c);a.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"};a.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}};a.prototype.html=
{element:'<div class="annotator-filter">\n  <strong>'+d._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+d._t("Previous")+'</button>\n<button class="annotator-filter-next">'+d._t("Next")+"</button>\n</span>\n<strong>"+d._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+d._t("Clear")+"</button>\n</span>"};a.prototype.options=
{appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(b,a){var c,d,f,g;if(!b||!a)return!1;g=b.split(/\s+/);d=0;for(f=g.length;d<f;d++)if(c=g[d],-1===a.indexOf(c))return!1;return!0}};a.prototype.pluginInit=function(){var b,a,c,f;f=this.options.filters;a=0;for(c=f.length;a<c;a++)b=f[a],this.addFilter(b);this.updateHighlights();this._setupListeners()._insertSpacer();if(!0===this.options.addAnnotationFilter)return this.addFilter({label:d._t("Annotation"),property:"text"})};a.prototype.destroy=
function(){var b,c;a.__super__.destroy.apply(this,arguments);c=f("html");b=parseInt(c.css("padding-top"),10)||0;c.css("padding-top",b-this.element.outerHeight());return this.element.remove()};a.prototype._insertSpacer=function(){var b,a;a=f("html");b=parseInt(a.css("padding-top"),10)||0;a.css("padding-top",b+this.element.outerHeight());return this};a.prototype._setupListeners=function(){var b,a,c,d;a=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"];c=0;for(d=a.length;c<
d;c++)b=a[c],this.annotator.subscribe(b,this.updateHighlights);return this};a.prototype.addFilter=function(a){var c;c=f.extend({label:"",property:"",isFiltered:this.options.isFiltered},a);var e,l,k,g;k=this.filters;g=[];e=0;for(l=k.length;e<l;e++)a=k[e],a.property===c.property&&g.push(a);g.length||(c.id="annotator-filter-"+c.property,c.annotations=[],c.element=this.filter.clone().appendTo(this.element),c.element.find("label").html(c.label).attr("for",c.id),c.element.find("input").attr({id:c.id,placeholder:d._t("Filter by ")+
c.label+"\u2026"}),c.element.find("button").hide(),c.element.data("filter",c),this.filters.push(c));return this};a.prototype.updateFilter=function(a){var c,e,d,k,g,m;a.annotations=[];this.updateHighlights();this.resetHighlights();if(e=f.trim(a.element.find("input").val())){c=this.highlights.map(function(){return f(this).data("annotation")});m=f.makeArray(c);k=0;for(g=m.length;k<g;k++)c=m[k],d=c[a.property],a.isFiltered(e,d)&&a.annotations.push(c);return this.filterHighlights()}};a.prototype.updateHighlights=
function(){this.highlights=this.annotator.element.find(".annotator-hl:visible");return this.filtered=this.highlights.not(this.classes.hl.hide)};a.prototype.filterHighlights=function(){var a,c,e,d,k,g,m;a=f.grep(this.filters,function(a){return!!a.annotations.length});d=(null!=(g=a[0])?g.annotations:void 0)||[];1<a.length&&(e=[],f.each(a,function(){return f.merge(e,this.annotations)}),k=[],d=[],f.each(e,function(){return-1===f.inArray(this,k)?k.push(this):d.push(this)}));a=this.highlights;c=g=0;for(m=
d.length;g<m;c=++g)c=d[c],a=a.not(c.highlights);a.addClass(this.classes.hl.hide);this.filtered=this.highlights.not(this.classes.hl.hide);return this};a.prototype.resetHighlights=function(){this.highlights.removeClass(this.classes.hl.hide);this.filtered=this.highlights;return this};a.prototype._onFilterFocus=function(a){a=f(a.target);a.parent().addClass(this.classes.active);return a.next("button").show()};a.prototype._onFilterBlur=function(a){if(!a.target.value)return a=f(a.target),a.parent().removeClass(this.classes.active),
a.next("button").hide()};a.prototype._onFilterKeyup=function(a){if(a=f(a.target).parent().data("filter"))return this.updateFilter(a)};a.prototype._findNextHighlight=function(a){var c,d,f,g;if(!this.highlights.length)return this;c=a?0:-1;g=a?-1:0;f=a?"lt":"gt";a=this.highlights.not("."+this.classes.hl.hide);d=a.filter("."+this.classes.hl.active);d.length||(d=a.eq(c));c=d.data("annotation");d=a.index(d[0]);f=a.filter(":"+f+"("+d+")").not(c.highlights).eq(g);f.length||(f=a.eq(g));return this._scrollToHighlight(f.data("annotation").highlights)};
a.prototype._onNextClick=function(a){return this._findNextHighlight()};a.prototype._onPreviousClick=function(a){return this._findNextHighlight(!0)};a.prototype._scrollToHighlight=function(a){a=f(a);this.highlights.removeClass(this.classes.hl.active);a.addClass(this.classes.hl.active);return f("html, body").animate({scrollTop:a.offset().top-(this.element.height()+20)},150)};a.prototype._onClearClick=function(a){return f(a.target).prev("input").val("").keyup().blur()};return a}(d.Plugin);d.Plugin.Markdown=
function(c){function a(b,c){this.updateTextField=g(this.updateTextField,this);null!=("undefined"!==typeof Showdown&&null!==Showdown?Showdown.converter:void 0)?(a.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter):console.error(d._t("To use the Markdown plugin, you must include Showdown into the page first."))}q(a,c);a.prototype.events={annotationViewerTextField:"updateTextField"};a.prototype.updateTextField=function(a,c){var e;e=d.Util.escape(c.text||"");return f(a).html(this.convert(e))};
a.prototype.convert=function(a){return this.converter.makeHtml(a)};return a}(d.Plugin);d.Plugin.Tags=function(c){function a(){this.setAnnotationTags=g(this.setAnnotationTags,this);this.updateField=g(this.updateField,this);return W=a.__super__.constructor.apply(this,arguments)}q(a,c);a.prototype.options={parseTags:function(a){var c;a=f.trim(a);c=[];a&&(c=a.split(/\s+/));return c},stringifyTags:function(a){return a.join(" ")}};a.prototype.field=null;a.prototype.input=null;a.prototype.pluginInit=function(){if(d.supported())return this.field=
this.annotator.editor.addField({label:d._t("Add some tags here")+"\u2026",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:d._t("Tag"),property:"tags",isFiltered:d.Plugin.Tags.filterCallback}),this.input=f(this.field).find(":input")};a.prototype.parseTags=function(a){return this.options.parseTags(a)};a.prototype.stringifyTags=function(a){return this.options.stringifyTags(a)};
a.prototype.updateField=function(a,c){var d;d="";c.tags&&(d=this.stringifyTags(c.tags));return this.input.val(d)};a.prototype.setAnnotationTags=function(a,c){return c.tags=this.parseTags(this.input.val())};a.prototype.updateViewer=function(a,c){a=f(a);return c.tags&&f.isArray(c.tags)&&c.tags.length?a.addClass("annotator-tags").html(function(){return f.map(c.tags,function(a){return'<span class="annotator-tag">'+d.Util.escape(a)+"</span>"}).join(" ")}):a.remove()};return a}(d.Plugin);d.Plugin.Tags.filterCallback=
function(c,a){var b,d,e,f,g,m,p,q;null==a&&(a=[]);e=0;d=[];if(c)for(d=c.split(/\s+/g),g=0,p=d.length;g<p;g++)if(b=d[g],a.length)for(m=0,q=a.length;m<q;m++)f=a[m],-1!==f.indexOf(b)&&(e+=1);return e===d.length};d.prototype.setupPlugins=function(c,a){var b,g,e,l,k,m;null==c&&(c={});null==a&&(a={});g=d.Util.getGlobal();e="Unsupported Auth Tags Filter Store AnnotateItPermissions".split(" ");g.Showdown&&e.push("Markdown");g=g.location.href.split(/#|\?/).shift()||"";g={Tags:{},Filter:{filters:[{label:d._t("User"),
property:"user"},{label:d._t("Tags"),property:"tags"}]},Auth:{tokenUrl:c.tokenUrl||"http://annotateit.org/api/token"},Store:{prefix:c.storeUrl||"http://annotateit.org/api",annotationData:{uri:g},loadFromSearch:{uri:g}}};for(b in a)D.call(a,b)&&0>x.call(e,b)&&e.push(b);f.extend(!0,g,a);m=[];l=0;for(k=e.length;l<k;l++)b=e[l],b in g&&!g[b]?m.push(void 0):m.push(this.addPlugin(b,g[b]));return m}}.call(this);
